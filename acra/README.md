# Acra Server Configuration Details

## Introduction
AcraServer, also known as the SQL Proxy, is an SQL database proxy that provides Acra’s security functionality by parsing SQL traffic between your application and the database, applying security functions where needed.

AcraServer sits between your application and your MySQL/PostgreSQL database and performs the following tasks:
- Captures all packets sent from the database driver to the database and back.
- Identifies packets related to SQL queries or data transfer.
- Passes SQL queries through the AcraCensor SQL firewall before further processing.
- Encrypts, tokenizes, and masks all recognized plaintext fields according to the encryptor configuration, then forwards them to the database as if sent by the application.
- Decrypts, detokenizes, and unmasks data from the database to the application as if sent by the database.
- Detects possible intrusions by recognizing poison records.

---

## Dataflows
<p align="center">
  <img src="src/dataflows.png" alt="dataflows" width="800"/>
</p>

---

## Installing Acra from the Repository

1. **Import the public key used by Cossack Labs to sign packages:**
   ```bash
   wget -qO - https://pkgs.cossacklabs.com/gpg | sudo apt-key add -
   ```

2. **Add the Cossack Labs repository to your `sources.list`:**  
   Add a line specifying your OS and its release name:
   ```bash
   deb https://pkgs.cossacklabs.com/stable/$OS $RELEASE main
   ```
   - **$OS**: Should be `debian` or `ubuntu`.
   - **$RELEASE**: Should be your Debian or Ubuntu release name.  
     You can determine this by running:
     ```bash
     lsb_release -cs
     ```
     (if you have `lsb_release` installed)

3. **Reload the local package database:**
   ```bash
   sudo apt-get update
   ```

4. **Install the Acra package:**
   ```bash
   sudo apt-get install acra
   ```
---

## Guidelines

### I. Key Generation

#### 1. Generate a Master Key

Acra uses multiple cryptographic keys, most of which are private and stored in encrypted form. **Acra Master Keys** are special keys used by each Acra component to decrypt private keys as needed. **It is critical to keep these master keys secure!**

- **Keystore version 1** uses a single master key called `ACRA_MASTER_KEY`, which is used only to encrypt stored private keys.
- **Keystore version 2** uses two distinct master keys: one for encrypting private key material, and another for signing public keystore data. Both are encoded within a single `ACRA_MASTER_KEY` value.

Use the `acra-keymaker` utility to generate a new master key and save it to a file.

> **Note:** By default, Acra components retrieve the master key from an environment variable as a base64-encoded string.

To generate a new master key and assign it to the environment variable on the corresponding server, run:

```bash
acra-keymaker --keystore=v2 --generate_master_key=master.key
export ACRA_MASTER_KEY=$(cat master.key | base64)
```

#### 2. Generate Encryption Keys

Once the master key is set up, all private keys generated by `acra-keymaker` will be encrypted before being written to disk.

```bash
acra-keymaker --client_id="" --tls_client_id_cert=<path> \
  --generate_symmetric_storage_key \
  --generate_hmac_key
```

By default, `acra-keymaker` will generate and place the resulting keys into the `.acrakeys` directory (you can change the directory name with the `--keys_output_dir` option).

---

### II. Running acra-server

#### 1. Configuration File

There are two ways to configure AcraServer:

- **Using command line flags**
- **Using a configuration file**

To use a configuration file, provide a YAML file with the `--config_file=path/to/config.yml` flag.  
Command line flags can be translated to YAML format:  
- `--foo=1` becomes `foo: 1`
- `--bar=test` becomes `bar: "test"`

#### 2. Listener

By default, AcraServer listens on:
- API: port **9090**
- SQL proxy: port **9393**

You can customize the host and port using:
```bash
--incoming_connection_string=tcp://127.0.0.1:13306
```

#### 3. Database

Tell Acra which DBMS you are using and how to connect:

- For **MySQL/MariaDB**:  
  ```bash
  --mysql_enable=true
  ```
- For **PostgreSQL**:  
  ```bash
  --postgresql_enable=true
  ```

Set the database address:
```bash
--db_host=<db_host> --db_port=<db_port>
```

#### Example

```bash
acra-server --config_file=path/to/config.yml -v -d
```

---

## Directory Structure

```bash
NT534-Database-Security-Suite/
├── .acrakeys/                 # Default directory containing generated keys (except the Master Key)
├── acra_tls_certs/            # Directory containing all TLS certificates for Application, AcraServer, and PostgreSQL
├── config/                    # Directory containing all YAML configuration files
├── acra-server.log            # Log file for acra-server
├── master.key                 # Master Key file   
└── README.md
```

---
